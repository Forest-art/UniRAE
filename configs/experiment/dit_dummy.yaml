# @package _global_

defaults:
  - override /data: imagenet
  - override /model: dit
  - override /trainer: cpu
  - override /callbacks: default
  - override /logger: tensorboard

# Experiment name
task_name: "dit_dummy_test"

# Data configuration (small test dataset)
data:
  data_dir: "data/test_hf"  # Small test dataset
  image_size: 128  # Smaller images for testing
  batch_size: 4
  num_workers: 0
  train_split: 0.8  # Split test data
  pin_memory: false
  use_hf_dataset: true
  hf_split: "train"
  hf_validation_split: "validation"

# Model configuration (simplified)
model:
  _target_: src.models.dit_module.DiTModule
  rae:
    _target_: src.models.stage1.RAE
    encoder_cls: 'Dinov2withNorm'
    encoder_config_path: 'facebook/dinov2-with-registers-base'
    encoder_input_size: 128
    encoder_params:
      dinov2_path: 'facebook/dinov2-with-registers-base'
      normalize: true
    decoder_config_path: 'models/decoders/dinov2/wReg_base/ViTB'  # Smaller decoder
    pretrained_decoder_path: 'models/decoders/dinov2/wReg_base/ViTB_n04/model.pt'
    noise_tau: 0.0
    reshape_to_2d: true
  dit:
    _target_: src.models.stage2.DiTwDDTHead
    input_size: 8  # Smaller latent size for 128x128 images
    patch_size: 1
    in_channels: 768
    hidden_size: [512, 1024]  # Smaller hidden sizes
    depth: [8, 2]  # Fewer layers
    num_heads: [8, 8]  # Fewer heads
    mlp_ratio: 4.0
    class_dropout_prob: 0.1
    num_classes: 10  # Fewer classes for testing
    use_qknorm: false
    use_swiglu: true
    use_rope: true
    use_rmsnorm: true
    wo_shift: false
    use_pos_embed: true
  dit_module:
    ema_decay: 0.999  # Faster EMA for testing
    learning_rate: 1e-4
    weight_decay: 0.0
    betas: [0.9, 0.95]
    warmup_steps: 10
    max_steps: 100
    num_classes: 10
    null_label: 10
    latent_size: [768, 8, 8]  # Smaller latent
    compile: false

# Trainer configuration (short training)
trainer:
  max_epochs: 2
  gradient_clip_val: 1.0
  accumulate_grad_batches: 1
  precision: 16
  check_val_every_n_epoch: 1
  log_every_n_steps: 1
  max_steps: 20  # Limit total steps for testing

# Callbacks
callbacks:
  model_checkpoint:
    monitor: "val/loss"
    mode: "min"
    save_top_k: 1
    save_last: true
    every_n_train_steps: 10
  early_stopping:
    monitor: "val/loss"
    patience: 5
    mode: "min"

# Paths
paths:
  root_dir: ${oc.env:PROJECT_ROOT,.}
  data_dir: ${paths.root_dir}/data
  log_dir: ${paths.root_dir}/logs
  output_dir: ${hydra:runtime.cwd}/outputs

# Hydra configuration
hydra:
  run:
    dir: ${paths.log_dir}/runs/${now:%Y-%m-%d}/${now:%H-%M-%S}
  sweep:
    dir: ${paths.log_dir}/multiruns/${now:%Y-%m-%d}/${now:%H-%M-%S}
    subdir: ${hydra.job.num}
  mode: MULTIRUN
  verbose: false